# 10mshake

Go 编写的币安 U 本位合约量化框架。程序自动筛选成交量最活跃的交易对，基于 3m/5m 双周期指标实时识别趋势，执行分阶段的开/平仓决策，并通过 WebSocket 追踪最新行情。

---

## 功能概览

- **成交量筛选**：每 4 小时拉取全部 USDT 永续合约 24h 成交量，只保留排名前 50% 的交易对作为候选池。
- **定时行情**：启动时用 REST 拉取 499 根 3m/5m K 线；之后在每个 3m、5m 整点自动拉取最新 10 根 K 线（带重试与去重），无需 WebSocket。
- **双周期策略**：
  - 5m 负责判定趋势方向（EMA 差值归一化、ADX 斜率、MACD 动量）。
  - 3m 负责择时（MACD 零轴滞回、EMA 快线回踩再上、动量放大）。
- **自动下单**：默认使用账户总余额的 1/3 作为保证金，乘以杠杆转换为名义价值，再除以最新价得到下单数量。支持固定手数。
- **持仓管理**：收紧→吊灯→确认三段式退出；结合最小持仓时长、回撤重置和价格再突破等再入门槛，避免高频震荡。
- **冷静期与过滤**：包含震荡过滤器（Choppiness/ADX）、BTC 15m 波动冷静期、点差与深度阈值、持仓冷却计数等保护。
- **日志驱动**：所有关键事件（筛选、评估、下单、退出、异常）均输出到标准日志，便于统一采集。
- **事件通知（可选）**：配置 Telegram 凭证后，启动提示、开/平仓、异常、BTC 冷静期等关键事件会推送至指定聊天，消息自动分段避免限流。

---

## 运行要求

- Go 1.21 及以上
- 一个可访问 Binance 合约 API 的网络环境
- 若启用真实交易，需要 Binance U 本位合约 API Key（具备下单权限）

---

## 快速开始

```bash
git clone <repo>
cd 10mshake

# 构建或直接运行
go build -o 10mshake
./10mshake
# 或
go run .
```

程序启动后会：

1. 尝试从当前目录读取 `.env`（无则忽略）。
2. 加载命令行参数，初始化 http/websocket 客户端。
3. 刷新成交量榜、订阅候选交易对、补齐历史 K 线。
4. 进入主循环（成交量刷新 / 指标评估 / 持仓快照），并在 WebSocket 事件中执行实时评估。

使用 `Ctrl+C` 或发送 `SIGTERM` 结束程序。

---

## 配置说明

### 环境变量（可写在 `.env`）

| 变量 | 说明 |
|------|------|
| `BINANCE_API_KEY` | 必填，自动交易使用的 API Key |
| `BINANCE_API_SECRET` | 必填，对应的 Secret |
| `BINANCE_ORDER_QTY` | 可选，固定下单数量（与 `-order-qty` 功能一致） |
| `TELEGRAM_BOT_TOKEN` | 可选，启用 Telegram 通知时的 Bot Token |
| `TELEGRAM_CHAT_ID` | 可选，对应接收方 Chat ID |

> `.env` 中的值不会覆盖已存在的系统环境变量。

### 常用命令行参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `-concurrency` | 10 | 并发拉取 REST 行情的最大协程数 |
| `-update-interval` | `10m` | 主循环定时重新评估候选池的周期 |
| `-volume-refresh` | `4h` | 刷新成交量前 50% 交易对的周期 |
| `-ema-fast / -ema-slow` | 7 / 25 | EMA 快慢线周期（两周期共用） |
| `-macd-fast / -macd-slow / -macd-signal` | 12 / 26 / 9 | MACD 参数 |
| `-adx-period` | 14 | ADX 周期 |
| `-adx-threshold` | 25 | ADX 最低强度 |
| `-ema-diff-threshold` | 0 | 5m EMA 差值最小要求（绝对值） |
| `-auto-trade` | `true` | 是否启用真实下单 |
| `-order-qty` | 0 | 固定下单数量（>0 时覆盖动态保证金计算） |
| `-max-positions` | 10 | 最大持仓数量 |
| `-leverage` | 5 | 默认杠杆倍数（建仓前会设置） |
| `-recv-window` | 5000 | Binance API recvWindow |

示例：以 5 分钟评估间隔运行观察模式（不下单）：

```bash
go run . -update-interval 5m -auto-trade=false
```

---

## 数据流程与组件

1. **成交量刷新**  
   `refreshVolumeList` 请求 `ticker/24hr`，结合 `exchangeInfo` 获取所有 USDT 永续合约成交量，按成交量降序截取前 50%。结果存入内存，供后续评估使用。

2. **行情补齐与轮询**  
   `EnsureWatchers` 为每个候选交易对初始化 `intervalWatcher`：先用 REST 拉取 499 根历史 K 线，随后由定时任务在每个 3m、5m 整点再次拉取最新 10 根 K 线并合并去重；当检测到 K 线更新时即刻触发策略评估。

3. **实时评估**  
   每当 WebSocket 接收到收盘 K 线，`OnCandleUpdate` 会：
   - 重算 `strategyResult`（包含 3m/5m 指标、最近涨跌幅、ATR/ADX 等）。
   - 根据当前持仓调用 `checkPositionForSymbol` 执行退出逻辑。
   - 在满足环境与重入条件时调用 `evaluateOpenForSymbol` 开仓尝试。

4. **定时评估**  
   主循环按照 `update-interval` 重新批量计算成交量池指标，并调用 `HandleSignals`（排序 + 动态调整下单量 + 批量尝试开仓）。

5. **持仓快照**  
   每 6 分钟刷新一次账户持仓，通过 REST 再次计算指标，确保退出逻辑有最新数据。

---

## Telegram 提醒

Telegram 默认为可选能力；只有在提供 `TELEGRAM_BOT_TOKEN` 与 `TELEGRAM_CHAT_ID` 时才会启用。

- 启动成功、开仓、平仓、交易错误、触发 BTC 波动冷静期等关键事件会推送至指定聊天。
- 开仓消息会附带该交易对在当前成交量前 50% 名单中的排名，便于快速了解活跃度。
- 每 5 分钟推送一次“持仓巡检”报告，列出当前仓位的主要指标值、收紧/吊灯/确认/基线退出条件的满足情况，以及继续持仓的原因说明。
- 单条消息超过 3,500 个字符时会自动分段发送，并在内部加入节流，避免触发 Telegram 限流。
- 发送失败时会在日志中记录具体错误，但不会中断策略运行。

---

## 策略细节

### 指标计算

- 基于 3m、5m 两个周期，计算 EMA(7/25)、MACD(12/26/9)、ADX(14)、ATR(22/50)、Choppiness、22 根最高/最低、MACD 直方图标准差等。
- 5m 方向指标：  
  - `Sep = (EMA_fast − EMA_slow) / ATR50`  
  - ADX 要求 ≥ max(`adx-direction-threshold`, 22)，近 3 根持续走强。
  - Sep 绝对值 ≥ 0.8 才视作明显趋势。
- 3m 择时指标：  
  - MACD Hist 必须穿越 ±ε（ε = 0.15 × Hist200 标准差）。  
  - 允许两种达成方式：零轴滞回突破、或价格回踩 3m EMA_fast 后重新站上。

### 开仓逻辑

- 按成交量前 50% 的交易对集合（附加当前持仓 symbol）作为评估对象。
- 若未设置固定手数，默认下单保证金 = 账户总余额 / 3。乘以杠杆后除以最新价得到下单张数，并通过 `AdjustQuantity` 对齐合约最小步长。
- 每个 symbol 同向仅可持有一笔仓位，总仓位数不超过 `max-positions`。
- 开仓前进行环境过滤：
  - 震荡过滤：`Choppiness > 61` 且 `ADX < 18` → 跳过。
  - BTC 15m 波动：若 TR ≥ 3 × ATR50，则进入 15 分钟冷静期，仅允许平仓。
  - 点差/深度：`(bestAsk - bestBid) / ATR22 ≤ 0.07` 且双侧深度充足。
  - 重入门槛：需要先触发 Reset，再突破上次退出价 ±0.6 × ATR3m，且冷却计数归零。

### 退出策略

1. **收紧阶段**（动量预警）：  
   3m MACD Hist 连续两根走弱且仍位于 ±ε 外，同时 5m Sep 回落到 ±0.8 内 → 触发收紧，计算吊灯止损：

   ```
   CE = HighestHigh(3m,22) - k × ATR22   (多头，空头取对称)
   ```

   `k = 2.8`（趋势强）或 `≈2.1`（较弱趋势，依据 ADX / Sep）。

2. **吊灯止损**：  
   价格触碰 CE，立即以市价平仓，标记为“硬退出”，记录最近平仓价并设置重入冷却。

3. **确认退出**（软退出）：  
   收紧状态下，只要满足以下任意一项且已达到最小持仓时长（默认 3 根 3m）：
   - 回撤 ≥ 1.8 × ATR22
   - 未实现利润回吐 ≥ 0.8R（R = 初始风险）
   - 5m Sep 回落到 ±0.5 区间并伴随 EMA_fast 斜率翻转

4. **基线退出**：  
   尚未收紧时，一旦 3m MACD Hist 穿越反向阈值，或 5m Sep 回到 ±0.5 并且 EMA_fast 斜率转向，即执行软退出。

### 重入与冷却

- 平仓后进入 `Exit → Reset → Re-entry` 状态机：
  - Exit：记录退出价 & 冷却计数（默认 6 根 3m）。
  - Reset：必须看到 MACD Hist 触及反向区间或价格回撤至 EMA_fast ±0.4 × ATR50。
  - Re-entry：价格重新突破退出价 ±0.6 × ATR50 且冷却归零，才允许同向重入。
- 额外的 `recentlyClosed` 标记保证冷却期间不会重复开仓。

---

## 日志与监控

- 所有关键信息通过 `log.Printf` 输出，可重定向到文件或接入日志系统。
- 示例日志：
  - `已刷新成交量前50%交易对，共 83 个`
  - `开始监听 BTCUSDT 3m，初始K线: 499 条`
  - `实时开多失败 BTCUSDT: binance api error ...`
  - `BTCUSDT LONG 触发动量预警，收紧止盈`
  - `完成行情评估，共评估 62 个交易对，生成策略: 5 条`
- 建议结合外部监控（如 Promtail + Loki/Grafana）对日志进行实时分析。

---

## 常见问题

**Q: 为什么日志显示“指标评估周期 10m0s”？**  
A: 这是 `-update-interval` 的值，与 WebSocket 实时评估互不冲突。若想改为 5 分钟，可传 `-update-interval 5m`。

**Q: 如果只想跑策略，不下真实订单？**  
A: 启动时传 `-auto-trade=false`。此时仍会计算指标与日志输出，但不会调用下单接口，也无需配置 API Key。

**Q: 如何调整默认参数？**  
A: 任何命令行参数都可以写在启动脚本或 systemd service 中。动态变化（如换杠杆）需要重启程序。

**Q: 是否会推送 Telegram？**  
A: 如同时配置 `TELEGRAM_BOT_TOKEN` 与 `TELEGRAM_CHAT_ID`，程序会在关键事件（启动、开平仓、异常、BTC 冷静期）自动推送文本消息，并内建节流与分段逻辑，正常使用不会触发限流；若未配置凭证，则不会发送任何 Telegram 请求。

---

## 开发与贡献

- 编译前请运行 `gofmt -w .`。
- 当前项目无第三方依赖，使用标准库 + `gorilla/websocket`。
- 欢迎提交 Issue/PR 一起完善筛选、指标或风控逻辑。

---

## 声明

本项目仅用于技术研究，真实交易需自担风险。币安 API 存在频率限制及网络波动，请务必先在测试账户或观察模式验证策略后，再投入真实资金。
